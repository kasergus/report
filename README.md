# Жизненный цикл защиты

Описание жизненного цикла защиты инфраструктуры согласно матрице атак MITRE. В описании приведены примеры утилит на каждый пункт матрицы.

### 1. Разведка

Защита сетевого периметра - весьма комплексное задание. В данном пункте для предотвращения обнаружения портов и их состояния нам понадобятся следующие утилиты:

> * [iptables](https://en.wikipedia.org/wiki/Iptables) (проверенный временем браузер)
> * [ipset](https://linux.die.net/man/8/ipset) (чтобы оптимизировать работу iptables поддержку списков)
> * [rsyslog](https://www.rsyslog.com) (крайне распространённая утилитя для логирования)

Алогритм действия таков: iptables просматривает весь трафик, помечая тэгом то всё, что не указано в списке разрешённого, а rsyslog читает всё с этим тегом, записывая ip адреса в неприемлых сообщений в файл, из которого ipset будет брать эти ip адреса, а затем iptables будет брать ip адреса из ipset'а и блокировать их. Дополнительные шаги необходимы для того, что бы iptables блокировал не сообщения, а именно ip адреса от этих сообщений. Это так же позволит избежать DDOS атаки.

Так же рекомендуется разделить сети маршрутизатора на разные потоки, дабы оптимизировать трафик и усложнить поиск критического АРМ в сети.

### 2. Подготовка ресурсов

Если не удалось просканировать сеть, то есть преодолеть сетевой периметр, злоумышленник вероятно будет пытаться найти "слитые" УЗ сотрудников, либо будет производить попытки скомпрометировать УЗ сотрудников путём фишинга. Для этого необходимо произвести обучение сотрудников: провести лекцию об опасности фишинга, а так же сделать проверочную попытку компрометации УЗ путём фишинга. Всем, кто перейдёт на фальшивые письма необходимо провести повторную лекцию.

> Пример утилиты для проверки сотрудников на устойчивость к фишингу: [gophish](https://getgophish.com).

### 3. Первоначальный доступ

Допустим, что злоумышленник всё же преодолел сетевой периметр, вошёл во внутрь системы, нашёл уязвимости и пытается их проэксплуатировать. Уязвимостей у системы может быть огромное множество, по сему будут даны общие советы и утилиты по устранению ВПО. Это непосредственно инцидент, при котором должен использоваться имеющийся плейбук, привелкаться необходимые спецалисты (L2 на случай выхода ВПО из уже имеющихся шаблонов и L3 на случай взлома критически важных объектов, дабы провести расследования по поводу инцидента и внедрить принципиально новые меры защиты). Провести ручное сканирование файловой системы/сети. Так же сотрудникам необходимо уведомить системного администратора при возникновеннии оповещения от антивируса. 

> Пример утилиты для ручного сканирования: [chkrootkit](https://www.chkrootkit.org).

> Примеры утилит для комплексной пассивной защиты АРМ: [apparmor](https://apparmor.net), [firewalld](https://firewalld.org).

### 4. Выполнение

Если злоумышленник смог запустить эксплойт, необходимо уведомить системного администратора о вирусе на компьютере, а так же выполнить необходимые действия, описанные в плане реагирования, который я сдавал ранее. В результате эксплойта могут происходить различные последствия, которые требуют уникального подхода к каждому. В нашем случае желательно загрузиться в safe mode или recovery mode (зависит от дистрибутива), и сделать анализ на ВПО.

> Утилита для запуска в safe/recovery mode в практически во всех дистрибутивах: [grub](https://www.gnu.org/software/grub).

### 5. Закрепление

Злоумышленник может прописывать себя автозапуск на различных уровнях (например при входе в систему или в УЗ пользователя), по сему рекомендуется выяснить где именно он себя прописал (это может быть загрузчик, описанный пунктом выше).

> Программы, в которые злоумышленник мог бы прописать ВПО в качестве автозапуска: [cron](https://en.wikipedia.org/wiki/Cron), [bash](https://www.gnu.org/software/bash).

### 6. Повышение привилегий

При попытке злоумышленника повысить привилегии ВПО нам поможет системы принудительного (мандатного) контроля доступа. С ними вероятность повышения привилегий файла становиться значительно меньше.

> Пример MAC (Mandatory Acces Control): [SELinux](https://github.com/SELinuxProject/selinux).

### 7. Предотвращение обнаружений

Есть различные способы предотвращения обнаружений, например смена mac адреса или утилита moonwalk. Вероятней всего злоумышленник попытается изменить имя пользователя, закрыть ssh и ftp порты, дабы никто не смог проникнуть на компьютер. Для того, что бы выявить попытку предотвращения обнаружения необходимо открыть какой либо из целевых портов (ssh, ftp или что-то другое), а затем просканировать компьютер на открытые порты (что-бы посмотреть, закрылись ли они произвольно или нет). Так же можно попытаться найти подозрительные процессы в системе.

> Утилита для сканирования хоста и получения информации об АРМ: [nmap](https://nmap.org).

> Утилита для мониторинга системных процессов: [htop](https://htop.dev).

### 8. Получение учётных данных

Типов взлома учётной записи зачастую два: брутфорс и социальная инженерия (например фишинг). Для второго типа нужно обратиться к пункту 2.

> Пример программ, которые могут зафиксировать брутфорс атаку: [ossec](https://www.ossec.net), [snort](https://www.snort.org).

### 9. Исследование

Инструкции по настройке iptables описаны в первом пункте, однако запрещать сканирование портов машинам в локальной сети (а ведь именно с них будет на данном этапе сканировать хосты злоумышленник), однако можно настроить системные демоны на логирование активности "шумных" (например nmap'a). 

> Пример системного демона для логирования активности в системе: [auditd](https://linux.die.net/man/8/auditd).

### 10. Перемещение внутри периметра

При попытке злоумышленника взломать другие машины, а так же при наличии информации о попытке сканирования локальной сети можно сделать следующее: начать использовать ssh ключи вместо пароля, сменить порт ssh на другой (для этого вам понадобится перезапустить демон), заблокировать пароль root. 

> Программы удалённого доступа: [ssh-server](https://en.wikipedia.org/wiki/Comparison_of_SSH_servers), [vsftpd](https://en.wikipedia.org/wiki/Vsftpd), [xrdp](http://www.xrdp.org/).

> Набор програм для управления демонами: [systemd](https://systemd.io).

> Команда для блокировки пароля root: [passwd](https://en.wikipedia.org/wiki/Passwd).

### 11. Сбор данных

Для того, что бы не позволить злоумышленнику собрать данные с компьютера в локальной сети, нам нужно использовать узловую систему обнаружения вторжений (HIDS).

> Пример HIDS: [OSSEC](https://www.ossec.net).

### 12. Управление и контроль

Для обнаружение стороннего защищённого канала, по которому будут передаваться скомпрометированные данные пользователя рекомендуется использовать универсальную (гибридную) систему обнаружения вторжений (UIDS).

> Пример UIDS: [Prelude SIEM](https://en.wikipedia.org/wiki/Prelude_SIEM_(Intrusion_Detection_System)).

### 13. Эксфильтрация данных

Для того, что бы не позволить просто так скомпрометировать файлы, рекомендуем ограничить доступ к важным файлам с помощью команд изменения обычных и расширенных атрибутов.

> Команды для изменения обычных и расширенных атрибутов файлов: [chmod](https://en.wikipedia.org/wiki/Chmod) и [chattr](https://en.wikipedia.org/wiki/Chattr).

### 14. Воздействие

На данном этапе ситуация критическая, нужно попытаться сохранить оставшиеся данные. Рекомендуется сделать резеврную копию базы данных и сайта заранее, в противном случае мы рискуем потерять всё. Разумеется это можно сделать когда злоумышленник будет владеть всем сайтом, УЗ и данными, однако в этом случае вероятность нашего успеха будет ниже.

> Программы выгрузки данных из бд: [Oracle](https://support.oracle.com/knowledge/Oracle%20Database%20Products/562556_1.html), [PostgreSQL](https://www.postgresql.org), [Microsoft SQL Server](https://www.microsoft.com/en-us/sql-server/sql-server-2022), [DB2](https://www.ibm.com/products/db2), [MySQL](https://www.mysql.com), [MongoDB](https://www.mongodb.com), [Cassandra](https://cassandra.apache.org/_/index.html).